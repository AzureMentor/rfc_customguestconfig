variables:
- group: vmusers

pool: 'Hosted VS2017'

steps:
- task: AzurePowerShell@3
  displayName: 'Publish Azure Policy definition for DeployIfNotExists rule'
  inputs:
    azureSubscription: 'ARM'
    azurePowerShellVersion: 'latestVersion'
    scriptType: 'inlineScript'
    inline: |
    $deployIfNotExists = @{
    Name        = '852a2bc9-9a15-446e-a19b-d5b29e60a52a'
    DisplayName = '[CCD_CustomGuestConfig]: Deploy extension to audit passwd file permissions'
    Description = 'Custom Deploy if Not Exists rule to add VM extension, MSI, and guest assignment.'
    Policy      = "$(Build.SourcesDirectory)\customPolicyFiles\deployIfNotExists.json"
    }
    New-AzureRMPolicyDefinition @deployIfNotExists
- task: AzureResourceGroupDeployment@2
  displayName: "Deploy virtual machine to Azure"
  inputs:
    azureSubscription: 'ARM'
    resourceGroupName: 'contosodev-ccd_customguestconfig'
    type: 'Complete'
    location: 'eastus2'
    csmFile: deploy.json
    overrideParameters: '-adminUsername $(adminUsername) -adminPassword $(adminPassword)'
